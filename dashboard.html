<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistem Keuangan Madrasah</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand text-success fw-bold" href="#">
                <img src="assets/logo.png" alt="Logo" style="height: 30px; margin-right: 10px;">
                Madrasah Al-Islam
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button id="logoutBtn" class="btn btn-outline-success">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link active text-success" href="#transaksi">Transaksi</a></li>
                        <li class="nav-item"><a class="nav-link text-success" href="#laporan">Laporan</a></li>
                        <li class="nav-item"><a class="nav-link text-success" href="#ekspor">Ekspor Excel</a></li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2 text-success">Dashboard Keuangan</h1>
                </div>

                <!-- Ringkasan Saldo -->
                <div class="row mb-4" id="ringkasan">
                    <div class="col-md-4">
                        <div class="card bg-success text-white shadow">
                            <div class="card-body">
                                <h5>Total Pemasukan</h5>
                                <h3 id="totalPemasukan">Rp 0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white shadow">
                            <div class="card-body">
                                <h5>Total Pengeluaran</h5>
                                <h3 id="totalPengeluaran">Rp 0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white shadow">
                            <div class="card-body">
                                <h5>Saldo Akhir</h5>
                                <h3 id="saldoAkhir">Rp 0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Tambah Transaksi -->
                <div class="card mb-4 shadow" id="transaksi">
                    <div class="card-header bg-success text-white">
                        <h5>Tambah Transaksi</h5>
                    </div>
                    <div class="card-body">
                        <form id="transaksiForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Jenis</label>
                                    <select class="form-select" id="jenis" required>
                                        <option value="">Pilih</option>
                                        <option value="pemasukan">Pemasukan</option>
                                        <option value="pengeluaran">Pengeluaran</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Jumlah (Rp)</label>
                                    <input type="number" class="form-control" id="jumlah" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Deskripsi</label>
                                    <input type="text" class="form-control" id="deskripsi" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Tanggal</label>
                                    <input type="date" class="form-control" id="tanggal" value="<?php echo date('Y-m-d'); ?>" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success mt-3">Tambah Transaksi</button>
                        </form>
                    </div>
                </div>

                <!-- Tabel Transaksi -->
                <div class="card mb-4 shadow">
                    <div class="card-header bg-success text-white">
                        <h5>Daftar Transaksi</h5>
                        <select class="form-select d-inline-block w-auto" id="filterBulan" style="width: 150px;">
                            <option value="">Semua Bulan</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabelTransaksi">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Jenis</th>
                                        <th>Jumlah</th>
                                        <th>Deskripsi</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Grafik -->
                <div class="card mb-4 shadow" id="laporan">
                    <div class="card-header bg-success text-white">
                        <h5>Grafik Pemasukan & Pengeluaran</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="grafikChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Tombol Ekspor -->
                <div class="card shadow" id="ekspor">
                    <div class="card-body text-center">
                        <button id="downloadExcel" class="btn btn-success btn-lg">Download Laporan Excel</button>
                        <p class="text-muted mt-2">Ekspor otomatis dilakukan setiap transaksi baru.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
    <script>
        // Cek login
        if (localStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'index.html';
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'index.html';
        });

        // Inisialisasi dashboard
        let transaksiData = JSON.parse(localStorage.getItem('transaksi')) || [];
        let chart;

        function renderTransaksi() {
            const tbody = document.querySelector('#tabelTransaksi tbody');
            tbody.innerHTML = '';
            const filterBulan = document.getElementById('filterBulan').value;
            let filteredData = transaksiData;
            if (filterBulan) {
                filteredData = transaksiData.filter(t => t.tanggal.startsWith(filterBulan));
            }

            filteredData.forEach((t, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${t.tanggal}</td>
                    <td>${t.jenis === 'pemasukan' ? 'Pemasukan' : 'Pengeluaran'}</td>
                    <td>${formatRupiah(t.jumlah)}</td>
                    <td>${t.deskripsi}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editTransaksi(${index})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="hapusTransaksi(${index})">Hapus</button>
                    </td>
                `;
            });

            updateRingkasan(filteredData);
            updateGrafik(filteredData);
            updateFilterBulan();
        }

        function updateRingkasan(data) {
            const pemasukan = data.filter(t => t.jenis === 'pemasukan').reduce((sum, t) => sum + t.jumlah, 0);
            const pengeluaran = data.filter(t => t.jenis === 'pengeluaran').reduce((sum, t) => sum + t.jumlah, 0);
            const saldo = pemasukan - pengeluaran;

            document.getElementById('totalPemasukan').textContent = formatRupiah(pemasukan);
            document.getElementById('totalPengeluaran').textContent = formatRupiah(pengeluaran);
            document.getElementById('saldoAkhir').textContent = formatRupiah(saldo);
        }

        function updateGrafik(data) {
            const ctx = document.getElementById('grafikChart').getContext('2d');
            const monthlyData = {};
            data.forEach(t => {
                const bulan = t.tanggal.substring(0, 7); // YYYY-MM
                if (!monthlyData[bulan]) monthlyData[bulan] = { pemasukan: 0, pengeluaran: 0 };
                if (t.jenis === 'pemasukan') monthlyData[bulan].pemasukan += t.jumlah;
                else monthlyData[bulan].pengeluaran += t.jumlah;
            });

            const labels = Object.keys(monthlyData);
            const pemasukanData = labels.map(l => monthlyData[l].pemasukan);
            const pengeluaranData = labels.map(l => monthlyData[l].pengeluaran);

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Pemasukan', data: pemasukanData, backgroundColor: '#4CAF50' },
                        { label: 'Pengeluaran', data: pengeluaranData, backgroundColor: '#f44336' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateFilterBulan() {
            const select = document.getElementById('filterBulan');
            const bulanUnik = [...new Set(transaksiData.map(t => t.tanggal.substring(0, 7)))].sort();
            select.innerHTML = '<option value="">Semua Bulan</option>' + bulanUnik.map(b => `<option value="${b}">${b}</option>`).join('');
            select.addEventListener('change', renderTransaksi);
        }

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
        }

        // Form tambah transaksi
        document.getElementById('transaksiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const jenis = document.getElementById('jenis').value;
            const jumlah = parseInt(document.getElementById('jumlah').value);
            const deskripsi = document.getElementById('deskripsi').value;
            const tanggal = document.getElementById('tanggal').value;

            transaksiData.unshift({ jenis, jumlah, deskripsi, tanggal }); // Tambah di atas
            localStorage.setItem('transaksi', JSON.stringify(transaksiData));
            renderTransaksi();
            eksporExcel(); // Otomatis ekspor
            this.reset();
            alert('Transaksi ditambahkan!');
        });

        // Edit (sederhana: prompt)
        function editTransaksi(index) {
            const t = transaksiData[index];
            const newJumlah = prompt('Jumlah baru:', t.jumlah);
            const newDeskripsi = prompt('Deskripsi baru:', t.deskripsi);
            if (newJumlah && newDeskripsi) {
                transaksiData[index].jumlah = parseInt(newJumlah);
                transaksiData[index].deskripsi = newDeskripsi;
                localStorage.setItem('transaksi', JSON.stringify(transaksiData));
                renderTransaksi();
            }
        }

        // Hapus
        function hapusTransaksi(index) {
            if (confirm('Hapus transaksi ini?')) {
                transaksiData.splice(index, 1);
                localStorage.setItem('transaksi', JSON.stringify(transaksiData));
                renderTransaksi();
            }
        }

        // Ekspor Excel
        function eksporExcel() {
            const ws = XLSX.utils.json_to_sheet(transaksiData.map(t => ({
                Tanggal: t.tanggal,
                Jenis: t.jenis === '
